{% extends 'dashboard_base.html' %}

{% block title %}Dashboard | DropFlow{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<style>
        body { font-family: 'Inter', sans-serif; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        .flatpickr-calendar.dark {
            background: #1e293b;
            border: 1px solid rgba(255,255,255,0.05);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.5);
        }
    </style>
{% endblock %}

{% block content %}
        <header class="h-16 flex items-center justify-between px-8 border-b border-white/5 bg-bg-dark/80 backdrop-blur-md sticky top-0 z-10">
            <div class="flex flex-col">
                <h1 class="text-xl font-bold text-white">Dashboard</h1>
                <span class="text-xs text-slate-400">Statistics</span>
            </div>
            <div class="flex items-center gap-3">
                <div class="flex bg-bg-card rounded-lg p-1 border border-white/5 text-sm">
                    <button @click="setPeriod('today')" :class="period === 'today' ? 'bg-white/10 text-white shadow-sm border border-white/5' : 'text-slate-400 hover:text-white border border-transparent'" class="px-3 py-1.5 rounded-md transition-colors">Today</button>
                    <button @click="setPeriod('7days')" :class="period === '7days' ? 'bg-white/10 text-white shadow-sm border border-white/5' : 'text-slate-400 hover:text-white border border-transparent'" class="px-3 py-1.5 rounded-md transition-colors">7 Days</button>
                    <button @click="setPeriod('30days')" :class="period === '30days' ? 'bg-white/10 text-white shadow-sm border border-white/5' : 'text-slate-400 hover:text-white border border-transparent'" class="px-3 py-1.5 rounded-md transition-colors">30 Days</button>
                    <button x-ref="datePickerBtn" :class="period === 'custom' ? 'bg-brand/20 text-brand-light shadow-sm border border-brand/30' : 'text-slate-400 hover:text-white border border-transparent'" class="px-3 py-1.5 rounded-md transition-colors flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                        <span x-text="customDateLabel"></span>
                    </button>
                </div>
            </div>
        </header>

        <div class="p-8 max-w-7xl mx-auto w-full space-y-6">
            <!-- Stat Cards -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                <div class="bg-bg-card border border-white/5 rounded-2xl p-6 shadow-lg">
                    <div class="flex justify-between items-start mb-4">
                        <div class="w-10 h-10 rounded-full bg-blue-500/10 text-blue-400 flex items-center justify-center text-lg">$</div>
                        <span class="text-xs font-medium flex items-center gap-1" :class="current.profitDir === 'up' ? 'text-emerald-400' : 'text-red-400'">
                            <span x-text="current.profitTrend"></span>
                        </span>
                    </div>
                    <h3 class="text-3xl font-bold text-white mb-1" x-text="current.profit"></h3>
                    <p class="text-sm text-slate-400">Profit</p>
                </div>
                <div class="bg-bg-card border border-white/5 rounded-2xl p-6 shadow-lg">
                    <div class="flex justify-between items-start mb-4">
                        <div class="w-10 h-10 rounded-full bg-purple-500/10 text-purple-400 flex items-center justify-center">
                            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" /></svg>
                        </div>
                        <span class="text-xs font-medium flex items-center gap-1" :class="current.ordersDir === 'up' ? 'text-emerald-400' : 'text-red-400'">
                            <span x-text="current.ordersTrend"></span>
                        </span>
                    </div>
                    <h3 class="text-3xl font-bold text-white mb-1" x-text="current.orders"></h3>
                    <p class="text-sm text-slate-400">Orders</p>
                </div>
                <div class="bg-bg-card border border-white/5 rounded-2xl p-6 shadow-lg">
                    <div class="flex justify-between items-start mb-4">
                        <div class="w-10 h-10 rounded-full bg-cyan-500/10 text-cyan-400 flex items-center justify-center text-lg">$</div>
                        <span class="text-xs font-medium flex items-center gap-1" :class="current.revenueDir === 'up' ? 'text-emerald-400' : 'text-red-400'">
                            <span x-text="current.revenueTrend"></span>
                        </span>
                    </div>
                    <h3 class="text-3xl font-bold text-white mb-1" x-text="current.revenue"></h3>
                    <p class="text-sm text-slate-400">Total Revenue</p>
                </div>
                <div class="bg-bg-card border border-white/5 rounded-2xl p-6 shadow-lg">
                    <div class="flex justify-between items-start mb-4">
                        <div class="w-10 h-10 rounded-full bg-slate-500/10 text-slate-400 flex items-center justify-center">
                            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" /></svg>
                        </div>
                        <span class="text-xs font-medium text-emerald-400 flex items-center gap-1">↗️ 100%</span>
                    </div>
                    <h3 class="text-3xl font-bold text-white mb-1" x-text="current.newProducts"></h3>
                    <p class="text-sm text-slate-400">New Products</p>
                </div>
            </div>

            <!-- Sales Chart -->
            <div class="bg-bg-card border border-white/5 rounded-2xl p-6 shadow-lg">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-bold text-white">Sales Overview (<span x-text="periodLabel"></span>)</h3>
                    <div class="flex gap-4 text-xs font-medium">
                        <span class="flex items-center gap-2"><span class="w-2.5 h-2.5 rounded-full bg-blue-500"></span> Revenue</span>
                        <span class="flex items-center gap-2"><span class="w-2.5 h-2.5 rounded-full bg-cyan-400"></span> Product Cost</span>
                        <span class="flex items-center gap-2"><span class="w-2.5 h-2.5 rounded-full bg-purple-500"></span> Profit</span>
                    </div>
                </div>
                <div id="salesChart" class="w-full h-72"></div>
            </div>
        </div>
    
{% endblock %}

{% block scripts %}
<script>
        document.addEventListener('alpine:init', () => {
            Alpine.data('dashboardData', () => ({
                period: '7days',
                customDateLabel: 'Custom Date',
                chartInstance: null,

                db: {
                    'today': {
                        profit: 'A$142',
                        profitTrend: '↗️ 5%',
                        profitDir: 'up',
                        orders: '18',
                        ordersTrend: '↗️ 2%',
                        ordersDir: 'up',
                        revenue: 'A$680',
                        revenueTrend: '↗️ 8%',
                        revenueDir: 'up',
                        newProducts: '2',
                        chartCats: ['8am', '10am', '12pm', '2pm', '4pm', '6pm'],
                        chartData: [
                            [120, 150, 180, 140, 190, 210],
                            [80, 100, 120, 90, 130, 140],
                            [40, 50, 60, 50, 60, 70]
                        ]
                    },
                    '7days': {
                        profit: 'A$5,069',
                        profitTrend: '↘️ 36%',
                        profitDir: 'down',
                        orders: '577',
                        ordersTrend: '↗️ 23%',
                        ordersDir: 'up',
                        revenue: 'A$24,320',
                        revenueTrend: '↗️ 26%',
                        revenueDir: 'up',
                        newProducts: '0',
                        chartCats: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                        chartData: [
                            [4400, 5000, 5600, 5900, 5700, 6200, 5800],
                            [2800, 3100, 3400, 3600, 3400, 3700, 3300],
                            [1600, 1900, 2200, 2300, 2300, 2500, 2500]
                        ]
                    },
                    '30days': {
                        profit: 'A$18,450',
                        profitTrend: '↗️ 12%',
                        profitDir: 'up',
                        orders: '2,104',
                        ordersTrend: '↗️ 8%',
                        ordersDir: 'up',
                        revenue: 'A$89,200',
                        revenueTrend: '↗️ 15%',
                        revenueDir: 'up',
                        newProducts: '14',
                        chartCats: ['Week 1', 'Week 2', 'Week 3', 'Week 4'],
                        chartData: [
                            [18000, 21000, 24000, 26200],
                            [12000, 14000, 16000, 17500],
                            [6000, 7000, 8000, 8700]
                        ]
                    },
                    'custom': {
                        profit: 'A$--',
                        profitTrend: '--',
                        profitDir: 'up',
                        orders: '--',
                        ordersTrend: '--',
                        ordersDir: 'up',
                        revenue: 'A$--',
                        revenueTrend: '--',
                        revenueDir: 'up',
                        newProducts: '--',
                        chartCats: ['Start', 'End'],
                        chartData: [[0, 0], [0, 0], [0, 0]]
                    }
                },

                get current() {
                    return this.db[this.period];
                },

                get periodLabel() {
                    if (this.period === 'today') return 'Today';
                    if (this.period === '7days') return 'Last 7 Days';
                    if (this.period === '30days') return 'Last 30 Days';
                    return this.customDateLabel;
                },

                setPeriod(newPeriod) {
                    this.period = newPeriod;
                    if (newPeriod !== 'custom') this.customDateLabel = 'Custom Date';
                    this.updateChart();
                },

                initDashboard() {
                    flatpickr(this.$refs.datePickerBtn, {
                        mode: "range",
                        dateFormat: "M j",
                        theme: "dark",
                        onClose: (selectedDates, dateStr) => {
                            if (dateStr && dateStr.includes('to')) {
                                this.period = 'custom';
                                this.customDateLabel = dateStr.replace(' to ', ' - ');
                                this.db.custom.profit = 'A$12,430';
                                this.db.custom.profitTrend = '↗️ 18%';
                                this.db.custom.profitDir = 'up';
                                this.db.custom.orders = '1,240';
                                this.db.custom.ordersTrend = '↗️ 10%';
                                this.db.custom.ordersDir = 'up';
                                this.db.custom.revenue = 'A$55,100';
                                this.db.custom.revenueTrend = '↗️ 22%';
                                this.db.custom.revenueDir = 'up';
                                this.db.custom.newProducts = '7';
                                this.db.custom.chartCats = ['Day 1', 'Day 2', 'Day 3', 'Day 4'];
                                this.db.custom.chartData = [[12000, 14000, 13500, 15600], [8000, 9500, 9000, 10500], [4000, 4500, 4500, 5100]];
                                this.updateChart();
                            }
                        }
                    });

                    let options = {
                        series: [
                            { name: 'Revenue', data: this.current.chartData[0] },
                            { name: 'Product Cost', data: this.current.chartData[1] },
                            { name: 'Profit', data: this.current.chartData[2] }
                        ],
                        chart: { type: 'area', height: 280, toolbar: { show: false }, background: 'transparent', fontFamily: 'Inter, sans-serif' },
                        colors: ['#3b82f6', '#22d3ee', '#a855f7'],
                        fill: { type: 'gradient', gradient: { shadeIntensity: 1, opacityFrom: 0.3, opacityTo: 0.05, stops: [0, 90, 100] } },
                        dataLabels: { enabled: false },
                        stroke: { curve: 'smooth', width: 2 },
                        xaxis: { categories: this.current.chartCats, axisBorder: { show: false }, axisTicks: { show: false }, labels: { style: { colors: '#64748b' } } },
                        yaxis: { labels: { style: { colors: '#64748b' } } },
                        grid: { borderColor: 'rgba(255,255,255,0.05)', strokeDashArray: 4 },
                        theme: { mode: 'dark' },
                        legend: { show: false }
                    };
                    this.chartInstance = new ApexCharts(document.querySelector("#salesChart"), options);
                    this.chartInstance.render();
                },

                updateChart() {
                    if (!this.chartInstance) return;
                    this.chartInstance.updateOptions({
                        xaxis: { categories: this.current.chartCats }
                    });
                    this.chartInstance.updateSeries([
                        { data: this.current.chartData[0] },
                        { data: this.current.chartData[1] },
                        { data: this.current.chartData[2] }
                    ]);
                }
            }));
        });
    </script>
{% endblock %}
